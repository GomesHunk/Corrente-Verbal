<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo das 5 Palavras - Sala</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      window.tailwind = window.tailwind || {}; tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <script>
        // Aplicar tema IMEDIATAMENTE no <html> (sem sobrescrever outras classes)
        (function () {
            const temaSalvo = localStorage.getItem('tema') || 'theme-dark';
            const root = document.documentElement;
            root.className = root.className
                .split(' ')
                .filter(c => !c.startsWith('theme-'))
                .join(' ')
                .trim();
            root.classList.add(temaSalvo);
        })();
    </script>
</head>

<body class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-950 to-black text-slate-100">
    <div class="game-container max-w-7xl mx-auto p-4 md:p-6">
        <!-- Header do Jogo -->
        <div class="game-header flex items-center justify-between rounded-xl border border-white/10 bg-white/5 backdrop-blur p-3 md:p-4 shadow-lg shadow-black/30">
            <div class="game-info">
                <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Corrente Verbal</h1>
                <div class="players-info flex items-center gap-3 mt-1">
                    <span class="player-name inline-flex items-center gap-2" id="meu-nome"></span>
                    <span class="vs text-slate-400">vs</span>
                    <div class="players-list flex flex-wrap gap-2" id="lista-jogadores-header"></div>
                </div>
            </div>
            <div class="game-controls flex items-center gap-2">
                <div class="theme-selector relative">
                    <button class="btn btn-secondary btn-small inline-flex items-center gap-2" onclick="toggleThemeMenu()" id="theme-btn">🎨 Tema</button>
                    <div class="theme-menu-dropdown hidden absolute right-0 mt-2 rounded-xl border border-white/10 bg-slate-800/90 p-2 shadow-xl backdrop-blur" id="theme-menu">
                        <div class="theme-thumb" onclick="alterarTema('theme-light')" title="Claro">
                            <img src="/static/themes/sun.svg" alt="Claro">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-dark')" title="Escuro">
                            <img src="/static/themes/moon.svg" alt="Escuro">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-matrix')" title="Matrix">
                            <img src="/static/themes/matrix.svg" alt="Matrix">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-starwars')" title="Star Wars">
                            <img src="/static/themes/starwars.svg" alt="Star Wars">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-strangerthings')" title="Stranger Things">
                            <img src="/static/themes/strangerthings.svg" alt="Stranger Things">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-flamengo')" title="Flamengo">
                            <img src="/static/themes/flamengo.svg" alt="Flamengo">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-botafogo')" title="Botafogo">
                            <img src="/static/themes/botafogo.svg" alt="Botafogo">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-vasco')" title="Vasco">
                            <img src="/static/themes/vasco.svg" alt="Vasco">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-fluminense')" title="Fluminense">
                            <img src="/static/themes/fluminense.svg" alt="Fluminense">
                        </div>
                    </div>
                </div>

                <button class="btn btn-danger btn-small" onclick="sairDaSala()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1">
                        </path>
                    </svg>
                    Sair
                </button>
            </div>
        </div>

        <!-- Indicador de Turno -->
        <div class="turn-indicator my-4 rounded-xl border border-white/10 bg-slate-800/60 p-3">
            <div class="turn-content flex items-center gap-2">
                <div class="turn-spinner hidden" id="spinner-turno"></div>
                <span id="texto-turno">Aguardando jogadores...</span>
            </div>
        </div>

        <!-- Seção: Aguardando Jogadores -->
        <div class="section" id="secao-aguardando">
            <div class="card text-center rounded-xl border border-white/10 bg-white/5 backdrop-blur p-5 shadow-xl">
                <h2 class="text-xl md:text-2xl font-semibold flex items-center justify-center gap-2">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z">
                        </path>
                    </svg>
                    Aguardando Jogadores
                </h2>
                <div class="waiting-spinner"></div>
                <p id="status-sala" class="text-slate-300">Conectando...</p>
                <!-- Lista de jogadores na sala de espera -->
                <div id="lista-jogadores-aguardando" class="players-list justify-center mt-4 flex flex-wrap gap-2"></div>
                
                <!-- Botão para marcar-se como pronto -->
                <div id="botao-pronto-container" class="my-4">
                    <button class="btn btn-success btn-large" onclick="alternarPronto()" id="btn-pronto">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        Marcar como Pronto
                    </button>
                    <p class="text-muted mt-2 text-sm" id="status-pronto-info">
                        Marque-se como pronto quando estiver preparado para jogar
                    </p>
                </div>
                
                <!-- Botão para iniciar partida (apenas para o criador) -->
                <div id="botao-iniciar-container" class="hidden my-6">
                    <button class="btn btn-primary btn-large" onclick="iniciarPartida()" id="btn-iniciar-partida" disabled>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        Iniciar Partida
                    </button>
                    <p class="text-muted mt-2 text-sm" id="iniciar-partida-info">
                        Aguardando todos os jogadores ficarem prontos
                    </p>
                </div>
                
                <div class="room-code flex items-center justify-center gap-2">
                    <span class="text-slate-400">Código da sala:</span>
                    <div class="code-display" id="codigo-atual"></div>
                    <button class="copy-btn" onclick="copiarCodigo()" title="Copiar código">Copiar</button>
                </div>
                <div id="config-info" class="text-muted"></div>
                <!-- Seletor de modo (apenas criador vê) -->
                <div id="container-modos" class="hidden mt-3 flex items-center gap-2 justify-center flex-wrap">
                    <label for="select-modo" class="text-muted">Modo de jogo:</label>
                    <select id="select-modo" class="form-input max-w-xs min-h-[36px]">
                        <option value="classico">Clássico</option>
                        <option value="cooperativo">Cooperativo</option>
                        <option value="duelo">Duelo (1v1)</option>
                        <option value="relampago">Relâmpago</option>
                    </select>
                    <span id="descricao-modo" class="text-muted text-sm"></span>
                </div>
            </div>
        </div>

        <!-- Seção: Definir Palavras -->
        <div class="section hidden" id="secao-palavras">
            <div class="card rounded-xl border border-white/10 bg-white/5 backdrop-blur p-5 shadow-xl">
                <h2 class="text-xl md:text-2xl font-semibold flex items-center gap-2">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                        </path>
                    </svg>
                    Defina suas <span id="num-palavras-texto">5</span> palavras
                </h2>
                <p class="text-muted mb-3">Escolha palavras que seus adversários terão que adivinhar!</p>
                
                <!-- Aviso de mínimo de jogadores -->
                <div class="alert alert-warning" id="aviso-min-jogadores">
                    Aguardando pelo menos 2 jogadores para iniciar o jogo...
                </div>

                <div class="words-input-container grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3" id="container-palavras">
                    <!-- Inputs serão gerados dinamicamente -->
                </div>

                <button class="btn btn-success btn-large mt-3" onclick="enviarPalavras()" id="btn-enviar-palavras">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Confirmar Palavras
                </button>
            </div>
        </div>

        <!-- Seção: Jogo -->
        <div class="section hidden" id="secao-jogo">
            <div class="game-board-new grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Coluna 1: Adivinhação / Espelho -->
                <div class="guess-panel rounded-xl border border-white/10 bg-white/5 backdrop-blur p-4">
                    <h3 id="titulo-adivinhacao" class="text-lg font-semibold flex items-center gap-2">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>

                        <span id="texto-titulo-adivinhacao">Sua Vez de Adivinhar</span>
                    </h3>

                    <div id="minha-vez" class="guess-controls mt-2">
                        <div class="current-word-display">
                            <div class="reference-word" id="palavra-referencia" style="display: none;">
                                <span class="reference-label">Palavra de Referência:</span>
                                <span class="reference-value" id="valor-referencia">---</span>
                            </div>
                            <div class="word-hint-large" id="dica-atual">---</div>
                            <div class="word-progress" id="progresso-palavra">Palavra 1 de 5</div>
                        </div>

                        <div class="guess-input-group flex items-center gap-2 mt-3">
                            <input type="text" id="input-tentativa" placeholder="Digite sua tentativa..." autocomplete="off" class="flex-1 rounded-lg border border-white/10 bg-slate-900/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button class="btn btn-primary">Tentar</button>
                        </div>
                    </div>

                    <!-- Espelho do Jogador Ativo -->
                    <div id="espelho-jogador" class="mirror-view hidden mt-4">
                        <h3 class="flex items-center gap-2">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Observando: <span id="mirror-player-name"></span>
                        </h3>

                        <p class="text-muted mb-2">Aguarde sua vez de jogar.</p>

                        <div class="current-word-display">
                            <div class="reference-word" id="mirror-palavra-referencia" style="display: none;">
                                <span class="reference-label">Palavra de Referência:</span>
                                <span class="reference-value" id="mirror-valor-referencia">---</span>
                            </div>
                            <div class="word-hint-large" id="mirror-dica-atual">---</div>
                            <div class="word-progress" id="mirror-progresso-palavra">Palavra 1 de 5</div>
                        </div>

                        <div class="guess-input-group mt-2">
                            <input type="text" id="mirror-input-tentativa" placeholder="Seu palpite silencioso..." autocomplete="off" disabled class="w-full rounded-lg border border-white/10 bg-slate-900/60 px-3 py-2">
                            <button class="btn btn-secondary mt-2" disabled>Observando</button>
                        </div>
                    </div>

                    <!-- Botões de Emoji -->
                    <div class="emoji-reactions mt-4">
                        <h4 class="font-semibold">🎭 Reações</h4>
                        <div class="emoji-buttons flex flex-wrap gap-2 mt-2">
                            <button class="emoji-btn" onclick="enviarEmoji('👍')" title="Gostei">👍</button>
                            <button class="emoji-btn" onclick="enviarEmoji('👎')" title="Não gostei">👎</button>
                            <button class="emoji-btn" onclick="enviarEmoji('🤔')" title="Pensativo">🤔</button>
                            <button class="emoji-btn" onclick="enviarEmoji('😂')" title="Rindo">😂</button>
                            <button class="emoji-btn" onclick="enviarEmoji('😱')" title="Surpreso">😱</button>
                            <button class="emoji-btn" onclick="enviarEmoji('🔥')" title="Incrível">🔥</button>
                            <button class="emoji-btn" onclick="enviarEmoji('💡')" title="Ideia">💡</button>
                            <button class="emoji-btn" onclick="enviarEmoji('❤️')" title="Amei">❤️</button>
                        </div>
                    </div>
                </div>

                <!-- Coluna 2: Suas Palavras -->
                <div class="my-words-panel rounded-xl border border-white/10 bg-white/5 backdrop-blur p-4">
                    <h4 class="flex items-center gap-2 font-semibold">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                            </path>
                        </svg>
                        Suas Palavras (Alvo: <span id="meu-alvo">---</span>)
                    </h4>
                    <div class="words-grid mt-2" id="minhas-palavras-grid">
                        <!-- Palavras serão geradas dinamicamente -->
                    </div>
                </div>

                <!-- Coluna 3: Todos os Jogadores -->
                <div class="all-players-panel rounded-xl border border-white/10 bg-white/5 backdrop-blur p-4">
                    <h4 class="flex items-center gap-2 font-semibold">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z">
                            </path>
                        </svg>
                        👥 Todos os Jogadores
                    </h4>
                    <div class="all-players-scroll mt-2" id="todos-jogadores-container">
                        <!-- Jogadores serão gerados dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Histórico -->
            <div class="history-panel mt-4 rounded-xl border border-white/10 bg-white/5 backdrop-blur p-4">
                <h3 class="font-semibold flex items-center gap-2">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Histórico de Tentativas
                </h3>
                <div class="history-list mt-2" id="lista-historico">
                    <div class="no-history">Nenhuma tentativa ainda</div>
                </div>
            </div>

            <!-- Chat -->
            <div class="chat-panel mt-4 rounded-xl border border-white/10 bg-white/5 backdrop-blur p-4">
                <div class="chat-header flex items-center gap-2 font-semibold">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                        </path>
                    </svg>
                    Chat
                </div>
                <div class="chat-messages mt-2" id="mensagens-chat">
                    <!-- Mensagens serão adicionadas dinamicamente -->
                </div>
                <div class="chat-input mt-2 flex items-center gap-2">
                    <input type="text" id="input-chat" placeholder="Digite uma mensagem..." maxlength="200" autocomplete="off" class="flex-1 rounded-lg border border-white/10 bg-slate-900/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button class="btn btn-primary btn-small">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Fim de Jogo -->
    <div id="modal-fim-jogo" class="modal hidden">
        <div class="modal-content rounded-2xl border border-white/10 bg-slate-900/90 backdrop-blur">
            <div class="modal-header">
                <h2 id="titulo-fim-jogo" class="text-2xl font-bold"></h2>
            </div>
            <div class="modal-body">
                <p id="mensagem-fim-jogo" class="text-lg"></p>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button class="btn btn-primary" onclick="voltarInicio()">Voltar ao Início</button>
                <button class="btn btn-secondary" onclick="fecharModalFim()">Continuar Conversando</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        // Variáveis globais
        let meuSid = null;
        let socket = null;
        let souCriador = false;
        let estouPronto = false;
        let statusJogadores = [];
        let salaEncontrada = false;
        let meuNome = '';
        let codigoSala = '';
        let numPalavras = 5;
        let estadoJogo = null;
        let totalJogadores = 0;
        let maxJogadores = 0;
        let playerId = null; // para reconexão estável

        // Inicialização
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const pathParts = window.location.pathname.split('/');

            meuNome = urlParams.get('jogador') || '';
            codigoSala = pathParts[pathParts.length - 1] || '';
            numPalavras = parseInt(urlParams.get('num_palavras')) || 5;

            // Gerar/recuperar playerId para reconexão
            try {
                playerId = localStorage.getItem('cv_player_id');
                if (!playerId) {
                    if (window.crypto?.randomUUID) playerId = crypto.randomUUID();
                    else playerId = 'pid_' + Math.random().toString(36).slice(2) + Date.now();
                    localStorage.setItem('cv_player_id', playerId);
                }
            } catch (_) {
                playerId = 'pid_' + Math.random().toString(36).slice(2) + Date.now();
            }

            if (!meuNome || !codigoSala) {
                mostrarToast('Parâmetros inválidos. Redirecionando...', 'error');
                setTimeout(() => window.location.href = '/', 2000);
                return;
            }

            document.getElementById('meu-nome').textContent = meuNome;
            document.getElementById('codigo-atual').textContent = codigoSala;
            document.getElementById('num-palavras-texto').textContent = numPalavras;

            inicializarSocket();

            // Enter para enviar tentativa/chat
            const inputTentativa = document.getElementById('input-tentativa');
            const inputChat = document.getElementById('input-chat');
            inputTentativa?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); tentarAdivinhar(); } });
            inputChat?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); enviarMensagem(); } });
        });

        function inicializarSocket() {
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 3;
            
            socket = io({
                transports: ['polling', 'websocket'],
                upgrade: true,
                timeout: 30000,
                reconnection: true,
                reconnectionDelay: 2000,
                reconnectionAttempts: 3,
                maxReconnectionAttempts: 3,
                forceNew: false,
                auth: { sala: codigoSala, nome: meuNome, player_id: playerId }
            });

            socket.on('connect', function () {
                meuSid = socket.id;
                salaEncontrada = false;
                socket.emit('entrar_na_sala', { sala: codigoSala, nome: meuNome, player_id: playerId });
                setTimeout(() => { gerarInputsPalavras(); }, 100);
                setTimeout(function() {
                    if (!salaEncontrada) {
                        mostrarToast('Não foi possível conectar à sala.', 'error');
                        setTimeout(function() { window.location.href = '/'; }, 3000);
                    }
                }, 15000);
            });

            socket.on('reconnect', function (attemptNumber) {
                mostrarToast('Reconectado ao servidor!', 'success');
                reconnectAttempts = 0;
                socket.emit('entrar_na_sala', { sala: codigoSala, nome: meuNome, player_id: playerId });
            });

            // Eventos do jogo/sala
            socket.on('sala_criada', function(data) {
                // Criador em página da sala (fallback), ajustar estados
                souCriador = true;
                salaEncontrada = true;
                mostrarSecao('secao-aguardando');
                statusJogadores = data.jogadores_info || [];
                const naoCriadores = (statusJogadores || []).filter(j => !j.criador);
                const prontos = naoCriadores.filter(j => j.pronto).length;
                atualizarBotaoIniciarPartida(naoCriadores.length, prontos, prontos === naoCriadores.length && naoCriadores.length > 0);
            });

            socket.on('jogador_entrou', function(data) {
                salaEncontrada = true;
                if ('sou_criador' in data) {
                    souCriador = data.sou_criador;
                }
                totalJogadores = data.total;
                maxJogadores = data.max;
                if (data.jogadores_info) {
                    statusJogadores = data.jogadores_info;
                    atualizarListaJogadoresComStatus(data.jogadores_info);
                    const naoCriadores = data.jogadores_info.filter(j => !j.criador);
                    const prontos = naoCriadores.filter(j => j.pronto).length;
                    atualizarBotaoIniciarPartida(naoCriadores.length, prontos, data.todos_prontos === true);
                } else {
                    atualizarListaJogadoresAguardando(data.jogadores || []);
                    const naoCriadores = (data.jogadores || []).filter(n => n !== meuNome);
                    atualizarBotaoIniciarPartida(naoCriadores.length, 0, false);
                }
                const configInfo = document.getElementById('config-info');
                if (configInfo) {
                    const modoTxt = data.modo ? ` • Modo: ${tituloModo(data.modo)}` : '';
                    configInfo.textContent = `${data.total}/${data.max} jogadores${modoTxt}`;
                }
                atualizarVisibilidadeSeletorModo();
                if (data.modo) setModoUI(data.modo);
            });

            socket.on('status_prontos_atualizado', function(data) {
                statusJogadores = data.jogadores;
                atualizarListaJogadoresComStatus(data.jogadores);
                const naoCriadores = data.jogadores.filter(j => !j.criador);
                const prontos = naoCriadores.filter(j => j.pronto).length;
                atualizarBotaoIniciarPartida(naoCriadores.length, prontos, data.todos_prontos === true);
                const prontosCount = data.jogadores_prontos;
                const total = data.total_jogadores;
                const info = document.getElementById('status-pronto-info');
                if (info) info.textContent = `${prontosCount}/${total} jogadores prontos`;
            });

            socket.on('meu_status', function(data) {
                souCriador = data.sou_criador;
                meuNome = data.nome;
                codigoSala = data.sala;
                atualizarVisibilidadeSeletorModo();
                if (statusJogadores && statusJogadores.length > 0) {
                    atualizarBotoesBaseadoNoTipo(statusJogadores);
                }
            });

            socket.on('novo_criador', function(data) {
                mostrarToast(`Novo criador da sala: ${data.nome}`, 'info');
                souCriador = (data.nome === meuNome);
                atualizarBotoesBaseadoNoTipo(statusJogadores || []);
                atualizarVisibilidadeSeletorModo();
            });

            socket.on('modo_atualizado', function(data) {
                setModoUI(data.modo);
                const configInfo = document.getElementById('config-info');
                if (configInfo) configInfo.textContent = `${totalJogadores}/${maxJogadores} jogadores • Modo: ${tituloModo(data.modo)}`;
                mostrarToast(`Modo alterado para: ${tituloModo(data.modo)}`, 'success');
            });

            socket.on('disconnect', function (reason) {
                console.log('[SOCKET] Desconectado:', reason);
                mostrarToast('Conexão perdida. Tentando reconectar...', 'warning');
                
                if (reason === 'io server disconnect') {
                    // O servidor forçou a desconexão, reconectar manualmente
                    socket.connect();
                }
            });

            socket.on('connect_error', function (error) {
                console.error('[SOCKET] Erro de conexão:', error);
                reconnectAttempts++;
                
                if (reconnectAttempts >= maxReconnectAttempts) {
                    console.log('[SOCKET] Máximo de tentativas atingido, parando reconexão');
                    socket.disconnect();
                    mostrarToast('Erro de conexão. Recarregue a página.', 'error');
                    return;
                }
                
                mostrarToast(`Problemas de conexão... (${reconnectAttempts}/${maxReconnectAttempts})`, 'warning');
            });

            socket.on('reconnect', function (attemptNumber) {
                console.log('[SOCKET] Reconectado após', attemptNumber, 'tentativas');
                mostrarToast('Reconectado ao servidor!', 'success');
                reconnectAttempts = 0;
                
                // Reentrar na sala após reconexão
                socket.emit('entrar_na_sala', {
                    sala: codigoSala,
                    nome: meuNome,
                    player_id: playerId
                });
            });

            socket.on('reconnecting', function (attemptNumber) {
                console.log('[SOCKET] Tentando reconectar...', attemptNumber);
                if (attemptNumber <= maxReconnectAttempts) {
                    mostrarToast(`Reconectando (${attemptNumber}/${maxReconnectAttempts})...`, 'info');
                }
            });

            // Listener para emojis recebidos
            socket.on('emoji_recebido', function (data) {
                console.log('Emoji recebido:', data);
                criarEmojiFlutante(data.emoji, data.nome);
            });

            // Eventos do jogo
            socket.on('sala_criada', function(data) {
                // Criador em página da sala (fallback), ajustar estados
                souCriador = true;
                salaEncontrada = true;
                mostrarSecao('secao-aguardando');
                statusJogadores = data.jogadores_info || [];
                const naoCriadores = (statusJogadores || []).filter(j => !j.criador);
                const prontos = naoCriadores.filter(j => j.pronto).length;
                atualizarBotaoIniciarPartida(naoCriadores.length, prontos, prontos === naoCriadores.length && naoCriadores.length > 0);
            });

            socket.on('jogador_entrou', function(data) {
                salaEncontrada = true;
                if ('sou_criador' in data) {
                    souCriador = data.sou_criador;
                }
                totalJogadores = data.total;
                maxJogadores = data.max;
                if (data.jogadores_info) {
                    statusJogadores = data.jogadores_info;
                    atualizarListaJogadoresComStatus(data.jogadores_info);
                    const naoCriadores = data.jogadores_info.filter(j => !j.criador);
                    const prontos = naoCriadores.filter(j => j.pronto).length;
                    atualizarBotaoIniciarPartida(naoCriadores.length, prontos, data.todos_prontos === true);
                } else {
                    atualizarListaJogadoresAguardando(data.jogadores || []);
                    const naoCriadores = (data.jogadores || []).filter(n => n !== meuNome);
                    atualizarBotaoIniciarPartida(naoCriadores.length, 0, false);
                }
                const configInfo = document.getElementById('config-info');
                if (configInfo) {
                    const modoTxt = data.modo ? ` • Modo: ${tituloModo(data.modo)}` : '';
                    configInfo.textContent = `${data.total}/${data.max} jogadores${modoTxt}`;
                }
                atualizarVisibilidadeSeletorModo();
                if (data.modo) setModoUI(data.modo);
            });

            // Novo evento para atualização de status de prontos
            socket.on('status_prontos_atualizado', function(data) {
                console.log('[DEBUG] Status prontos atualizado:', data);
                statusJogadores = data.jogadores;
                atualizarListaJogadoresComStatus(data.jogadores);
                const naoCriadores = data.jogadores.filter(j => !j.criador);
                const prontos = naoCriadores.filter(j => j.pronto).length;
                atualizarBotaoIniciarPartida(naoCriadores.length, prontos, data.todos_prontos === true);
                const prontosCount = data.jogadores_prontos;
                const total = data.total_jogadores;
                const info = document.getElementById('status-pronto-info');
                if (info) info.textContent = `${prontosCount}/${total} jogadores prontos`;
            });

            socket.on('pode_comecar', function (data) {
                console.log('Pode começar:', data);
                document.getElementById('status-sala').textContent = data.msg;
                atualizarListaJogadoresAguardando(data.jogadores || []);

                // Ocultar botões de iniciar partida e pronto quando a partida começa
                document.getElementById('botao-iniciar-container').classList.add('hidden');
                document.getElementById('botao-pronto-container').classList.add('hidden');

                // Atualizar configuração para todos os jogadores
                if (data.num_palavras) {
                    numPalavras = data.num_palavras;
                    document.getElementById('num-palavras-texto').textContent = numPalavras;
                    gerarInputsPalavras(); // Regenerar com o número correto
                }

                // Mostrar seção de palavras
                mostrarSecao('secao-palavras');
            });

            socket.on('status_palavras_atualizado', function (data) {
                console.log('Status palavras atualizado:', data);
                mostrarToast(data.msg, 'info');
                
                // Verificar se há jogadores pendentes
                if (data.jogadores_pendentes && data.jogadores_pendentes.length > 0) {
                    const mensagem = `Aguardando palavras de: ${data.jogadores_pendentes.join(', ')}`;
                    document.getElementById('status-sala').textContent = mensagem;
                }
                
                if (data.status_jogadores) {
                    atualizarStatusPalavras(data.status_jogadores);
                }
            });

            socket.on('palavras_recebidas', function (data) {
                console.log('Palavras recebidas:', data);
                mostrarToast(data.msg, 'success');
                document.getElementById('btn-enviar-palavras').disabled = true;
                document.getElementById('btn-enviar-palavras').textContent = 'Palavras Enviadas ✓';
            });

            socket.on('jogo_iniciado', function (data) {
                console.log('Jogo iniciado:', data);
                mostrarToast(data.msg, 'success');
                estadoJogo = data.estado;
                const criadorSid = estadoJogo.criador;
                // meuSid já está definido globalmente
                mostrarSecao('secao-jogo');
                atualizarInterfaceJogo();
            });

            socket.on('jogador_saiu', function (data) {
                console.log('Jogador saiu:', data);
                mostrarToast(data.msg, 'info');
                
                // Atualizar lista de jogadores
                if (data.jogadores_restantes) {
                    atualizarListaJogadoresAguardando(data.jogadores_restantes);
                    // Atualizar botão de iniciar partida se estamos na sala de espera
                    if (!estadoJogo) {
                        atualizarBotaoIniciarPartida(data.jogadores_restantes.length, 10); // Assumindo máximo de 10
                    }
                }
            });

            socket.on('resposta_tentativa', function (data) {
                console.log('Resposta tentativa:', data);
                estadoJogo = data.estado;

                adicionarHistorico(data.jogador, data.palavra_tentada, data.acertou, data.mensagem);

                if (data.acertou) {
                    mostrarToast(`${data.jogador}: ${data.mensagem}`, 'success');
                } else {
                    mostrarToast(`${data.jogador}: ${data.mensagem}`, 'error');
                }

                atualizarInterfaceJogo();
                limparInputTentativa();
            });

            socket.on('fim_de_jogo', function (data) {
                console.log('Fim de jogo:', data);
                document.getElementById('titulo-fim-jogo').textContent = '🎉 Fim de Jogo!';
                document.getElementById('mensagem-fim-jogo').innerHTML = `
                    <div class="winner-announcement">${data.mensagem}</div>
                    <div class="loading-gabarito">
                        <div class="spinner"></div>
                        <p>Carregando gabarito...</p>
                    </div>
                `;
                document.getElementById('modal-fim-jogo').classList.remove('hidden');
                mostrarToast(data.mensagem, 'success');

                // Solicitar gabarito completo
                socket.emit('obter_gabarito', { sala: codigoSala });
            });

            socket.on('gabarito_completo', function (data) {
                console.log('Gabarito completo:', data);
                exibirGabarito(data.gabarito);
            });

            socket.on('jogo_reiniciado', function (data) {
                console.log('Jogo reiniciado:', data);
                mostrarToast(data.msg, 'success');

                // Resetar interface
                estadoJogo = null;
                document.getElementById('modal-fim-jogo').classList.add('hidden');

                // Voltar para seção de definir palavras
                mostrarSecao('secao-palavras');

                // Resetar botão de enviar palavras
                const btnEnviar = document.getElementById('btn-enviar-palavras');
                btnEnviar.disabled = false;
                btnEnviar.textContent = 'Confirmar Palavras';
                btnEnviar.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Confirmar Palavras
                `;

                // Limpar inputs de palavras
                for (let i = 1; i <= numPalavras; i++) {
                    const input = document.getElementById(`palavra-${i}`);
                    if (input) input.value = '';
                }

                // Limpar histórico e chat
                document.getElementById('lista-historico').innerHTML = '<div class="no-history">Nenhuma tentativa ainda</div>';
                document.getElementById('mensagens-chat').innerHTML = '';
            });

            socket.on('nova_mensagem_chat', function (data) {
                console.log('Nova mensagem chat:', data);
                adicionarMensagemChat(data.jogador, data.mensagem, data.timestamp);
            });

            socket.on('erro', function (data) {
                console.error('Erro:', data);
                mostrarToast(data.msg, 'error');
                
                // Se for erro de sala não encontrada, redirecionar após um tempo
                if (data.msg && data.msg.includes('Sala não encontrada')) {
                    setTimeout(function() {
                        mostrarToast('Redirecionando para a página inicial...', 'info');
                        setTimeout(function() {
                            window.location.href = '/';
                        }, 2000);
                    }, 3000);
                }
            });

            socket.on('error', function (data) {
                console.error('Error:', data);
                mostrarToast(data.msg, 'error');
                
                // Reabilitar botão de iniciar partida se houve erro
                const botao = document.getElementById('btn-iniciar-partida');
                if (botao && data.msg && data.msg.includes('pronto')) {
                    botao.disabled = true;
                    botao.innerHTML = `
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        ⏳ Aguardando Jogadores
                    `;
                }
            });
            
            // Ouvir mensagens de aviso (não são erros, mas informações importantes)
            socket.on('aviso', function (data) {
                console.log('Aviso:', data);
                mostrarToast(data.msg, 'warning');
                
                // Se o aviso contém informação sobre o criador ter saído, atualizar a interface
                if (data.msg && data.msg.includes('criador da sala')) {
                    document.getElementById('status-sala').textContent += ' (Criador saiu)';
                }
            });

            // Novo evento para processar status do usuário
            socket.on('meu_status', function(data) {
                console.log('[DEBUG] Meu status recebido:', data);
                
                // Atualizar variáveis globais
                souCriador = data.sou_criador;
                meuNome = data.nome;
                codigoSala = data.sala;
                
                console.log(`[DEBUG] Configurado: souCriador=${souCriador}, nome=${meuNome}`);
                
                // Atualizar interface baseada no status
                if (statusJogadores && statusJogadores.length > 0) {
                    atualizarBotoesBaseadoNoTipo(statusJogadores);
                }
            });

            socket.on('estado_atualizado', function(data) {
                console.log('[DEBUG] Estado atualizado recebido');
                estadoJogo = data.estado;
                atualizarInterfaceJogo();
            });
        }

        function atualizarBotoesBaseadoNoTipo(jogadores) {
            const botaoProntoContainer = document.getElementById('botao-pronto-container');
            const botaoIniciarContainer = document.getElementById('botao-iniciar-container');
            // Confiar primeiro na flag global souCriador
            const ehCriador = souCriador || (jogadores || []).some(j => j.nome === meuNome && j.criador);
            if (ehCriador) {
                botaoProntoContainer?.classList.add('hidden');
                botaoIniciarContainer?.classList.remove('hidden');
            } else {
                botaoIniciarContainer?.classList.add('hidden');
                botaoProntoContainer?.classList.remove('hidden');
            }
        }

        function atualizarVisibilidadeSeletorModo() {
            const box = document.getElementById('container-modos');
            if (!box) return;
            if (souCriador) box.classList.remove('hidden'); else box.classList.add('hidden');
        }

        function tituloModo(modo) {
            switch (modo) {
                case 'cooperativo': return 'Cooperativo';
                case 'duelo': return 'Duelo (1v1)';
                case 'relampago': return 'Relâmpago';
                default: return 'Clássico';
            }
        }

        function setModoUI(modo) {
            const sel = document.getElementById('select-modo');
            const desc = document.getElementById('descricao-modo');
            if (sel) sel.value = modo;
            if (desc) {
                const map = {
                    classico: 'Turnos padrão, todos jogam.',
                    cooperativo: 'Todos contra o tempo, ajuda mútua.',
                    duelo: 'Dois jogadores se alternam.',
                    relampago: 'Turnos curtos e dinâmicos.'
                };
                desc.textContent = map[modo] || '';
            }
        }

        // Wire do seletor de modo (apenas criador emite)
        document.addEventListener('DOMContentLoaded', () => {
            const sel = document.getElementById('select-modo');
            sel?.addEventListener('change', () => {
                const modo = sel.value;
                if (!souCriador) { setModoUI(modo); return; }
                socket.emit('selecionar_modo', { sala: codigoSala, nome: meuNome, modo });
            });
        });

        // Adicionar botão de transferir host na lista de jogadores (onde já há expulsar)
        function atualizarTodosJogadores() {
            if (!estadoJogo) return;
            const container = document.getElementById('todos-jogadores-container');
            container.innerHTML = '';
            const sou_criador_sid = estadoJogo.criador; // SID do criador
            const euSouCriador = (sou_criador_sid === meuSid);
            estadoJogo.jogadores.forEach(jogador => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-section';
                const icone = jogador.nome === estadoJogo.jogador_da_vez ? '🎮' : '👤';
                const status = jogador.nome === estadoJogo.jogador_da_vez ? ' (Jogando)' : '';
                const descobertas = jogador.palavras_descobertas ? jogador.palavras_descobertas.filter(d => d).length : 0;
                const total = estadoJogo.config.num_palavras;
                const nomeAlvo = jogador.alvo || '---';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'player-header';
                headerDiv.innerHTML = `<h5>${icone} ${jogador.nome}${status}</h5><span class="player-progress">${descobertas}/${total}</span>`;
                if (euSouCriador && jogador.nome !== meuNome) {
                    const btnTransfer = document.createElement('button');
                    btnTransfer.className = 'btn btn-sm btn-secondary';
                    btnTransfer.title = 'Transferir liderança para este jogador';
                    btnTransfer.textContent = '👑';
                    btnTransfer.onclick = () => transferirHost(jogador.nome);
                    headerDiv.appendChild(btnTransfer);

                    const btnExpulsar = document.createElement('button');
                    btnExpulsar.className = 'btn btn-sm btn-danger';
                    btnExpulsar.title = 'Expulsar jogador';
                    btnExpulsar.textContent = '🛑';
                    btnExpulsar.onclick = () => expulsarJogador(jogador.nome);
                    headerDiv.appendChild(btnExpulsar);
                }
                playerDiv.appendChild(headerDiv);
                playerDiv.innerHTML += `
                    <div class="player-target-info">
                        <span class="target-label">Adivinhando palavras de:</span>
                        <span class="target-name">${nomeAlvo}</span>
                    </div>
                    <div class="player-words-grid" id="player-${jogador.nome.replace(/\s+/g, '_')}-grid"></div>
                `;
                container.appendChild(playerDiv);
                const grid = document.getElementById(`player-${jogador.nome.replace(/\s+/g, '_')}-grid`);
                for (let i = 0; i < total; i++) {
                    const wordDiv = document.createElement('div');
                    wordDiv.className = 'mini-word-card';
                    const descoberta = jogador.palavras_descobertas && jogador.palavras_descobertas[i];
                    const dica = jogador.dicas && jogador.dicas[i] ? jogador.dicas[i] : '?';
                    wordDiv.classList.add(descoberta ? 'discovered' : 'not-discovered');
                    wordDiv.innerHTML = `<div class="mini-word-hint">${dica}</div><div class="mini-word-status">${descoberta ? '✓' : ''}</div>`;
                    grid.appendChild(wordDiv);
                }
            });
        }

        function transferirHost(nomeJogador) {
            if (!souCriador) return;
            if (confirm(`Transferir liderança para ${nomeJogador}?`)) {
                socket.emit('transferir_criador', { sala: codigoSala, para: nomeJogador });
            }
        }

        function gerarInputsPalavras() {
            if (!numPalavras || numPalavras <= 0) {
                console.log('NumPalavras não definido ainda');
                return;
            }
            
            const container = document.getElementById('container-palavras');
            if (!container) {
                console.log('Container de palavras não encontrado!');
                return;
            }
            
            container.innerHTML = '';
            
            for (let i = 1; i <= numPalavras; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `palavra-${i}`;
                input.placeholder = `Palavra ${i}`;
                input.maxLength = 20;
                input.required = true;
                input.className = 'form-input';
                
                container.appendChild(input);
            }
        }

        function enviarPalavras() {
            const palavras = [];
            let todasPreenchidas = true;

            for (let i = 1; i <= numPalavras; i++) {
                const input = document.getElementById(`palavra-${i}`);
                const palavra = input.value.trim();

                if (!palavra) {
                    mostrarToast(`Por favor, preencha a palavra ${i}`, 'error');
                    input.focus();
                    return;
                }

                if (palavra.length < 2) {
                    mostrarToast(`A palavra ${i} deve ter pelo menos 2 letras`, 'error');
                    input.focus();
                    return;
                }

                if (!/^[a-zA-ZÀ-ÿ\s]+$/.test(palavra)) {
                    mostrarToast(`A palavra ${i} deve conter apenas letras`, 'error');
                    input.focus();
                    return;
                }

                palavras.push(palavra);
            }

            socket.emit('enviar_palavras', {
                sala: codigoSala,
                nome: meuNome,
                palavras: palavras
            });
        }

        function tentarAdivinhar() {
            const input = document.getElementById('input-tentativa');
            const palavra = input.value.trim();

            if (!palavra) {
                mostrarToast('Digite uma palavra para tentar!', 'error');
                input.focus();
                return;
            }

            socket.emit('tentar_adivinhar', {
                sala: codigoSala,
                nome: meuNome,
                palavra: palavra
            });
        }

        function enviarMensagem() {
            const input = document.getElementById('input-chat');
            const mensagem = input.value.trim();

            if (!mensagem) return;

            socket.emit('enviar_mensagem_chat', {
                sala: codigoSala,
                nome: meuNome,
                mensagem: mensagem
            });

            input.value = '';
        }

        function atualizarInterfaceJogo() {
            if (!estadoJogo) return;

            // Atualizar indicador de turno
            const indicador = document.getElementById('indicador-turno');
            const textoTurno = document.getElementById('texto-turno');
            const minhaVez = document.getElementById('minha-vez');

            if (estadoJogo.jogador_da_vez === meuNome) {
                indicador.className = 'turn-indicator my-turn';
                textoTurno.textContent = 'Sua vez de jogar!';
                if (minhaVez) minhaVez.classList.remove('hidden');
            } else {
                indicador.className = 'turn-indicator opponent-turn';
                textoTurno.textContent = `Vez de ${estadoJogo.jogador_da_vez}`;
                if (minhaVez) minhaVez.classList.add('hidden');
            }

            // Encontrar meus dados e do meu alvo
            const meusDados = estadoJogo.jogadores.find(j => j.nome === meuNome);
            if (meusDados) {
                const meuAlvoElem = document.getElementById('meu-alvo');
                const dicaAtualElem = document.getElementById('dica-atual');
                const progressoPalavraElem = document.getElementById('progresso-palavra');
                
                if (meuAlvoElem) meuAlvoElem.textContent = meusDados.alvo;
                if (dicaAtualElem) dicaAtualElem.textContent = meusDados.dica_atual || '---';
                if (progressoPalavraElem) {
                    progressoPalavraElem.textContent = `Palavra ${meusDados.palavra_atual_index + 1} de ${estadoJogo.config.num_palavras}`;
                }

                // Atualizar palavra de referência
                const palavraReferencia = document.getElementById('palavra-referencia');
                const valorReferencia = document.getElementById('valor-referencia');

                if (palavraReferencia && valorReferencia) {
                    if (meusDados.palavra_anterior && meusDados.palavra_anterior.trim()) {
                        palavraReferencia.style.display = 'block';
                        valorReferencia.textContent = meusDados.palavra_anterior;
                    } else {
                        palavraReferencia.style.display = 'none';
                    }
                }
            }

            // Atualizar minhas palavras (como alvo)
            const meuAlvo = estadoJogo.jogadores.find(j => j.nome === meusDados?.alvo);
            if (meuAlvo) {
                atualizarGridPalavras('minhas-palavras-grid', meuAlvo, true);
            }

            // Atualizar todos os jogadores
            atualizarTodosJogadores();

            // Atualizar lista de jogadores no header
            const jogadores = estadoJogo.jogadores.map(j => j.nome);
            atualizarListaJogadores(jogadores);
        }

        function atualizarGridPalavras(gridId, dadosJogador, saoMinhasPalavras) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            for (let i = 0; i < estadoJogo.config.num_palavras; i++) {
                const div = document.createElement('div');
                div.className = 'word-card';

                // Determinar se a palavra foi descoberta
                const descoberta = dadosJogador.palavras_descobertas && dadosJogador.palavras_descobertas[i];

                if (descoberta) {
                    div.classList.add('discovered');
                } else {
                    div.classList.add('not-discovered');
                }

                const dica = dadosJogador.dicas && dadosJogador.dicas[i] ? dadosJogador.dicas[i] : '?';
                const status = descoberta ? '✓' : '';

                div.innerHTML = `
                    <div class="word-number">${i + 1}</div>
                    <div class="word-hint">${dica}</div>
                    <div class="word-status">${status}</div>
                `;

                grid.appendChild(div);
            }
        }

        function atualizarListaJogadores(jogadores) {
            const lista = document.getElementById('lista-jogadores-header');
            lista.innerHTML = '';

            // Filtrar para mostrar apenas os outros jogadores (não o próprio usuário)
            const outrosJogadores = jogadores.filter(jogador => jogador !== meuNome);

            outrosJogadores.forEach(jogador => {
                const span = document.createElement('span');
                span.className = 'player-chip';
                span.textContent = jogador;

                // Destacar quem está na vez
                if (estadoJogo && estadoJogo.jogador_da_vez === jogador) {
                    span.classList.add('target');
                }

                lista.appendChild(span);
            });
        }

        function atualizarListaJogadoresAguardando(jogadores) {
            const container = document.getElementById('lista-jogadores-aguardando');
            if (!container) return;
            container.innerHTML = '';
            
            // Atualizar também o header
            const headerContainer = document.getElementById('lista-jogadores-header');
            if (headerContainer) headerContainer.innerHTML = '';
            
            jogadores.forEach(nome => {
                // Para o container principal de espera
                const chip = document.createElement('div');
                chip.className = 'player-chip';
                // Adiciona um ícone para cada jogador na lista de espera
                chip.innerHTML = `👤 ${nome}`;
                container.appendChild(chip);
                
                // Também atualizar o header se não for meu nome
                if (nome !== meuNome && headerContainer) {
                    const headerChip = document.createElement('span');
                    headerChip.className = 'player-opponent';
                    headerChip.textContent = nome;
                    headerContainer.appendChild(headerChip);
                }
            });
            
            // Mostrar quantos jogadores estão na sala
            if (jogadores.length >= 2) {
                document.getElementById('status-sala').innerHTML = 
                    `<span class="ready-status">✅ ${jogadores.length} jogadores conectados - Prontos para jogar!</span>`;
            } else {
                document.getElementById('status-sala').textContent = 
                    `Aguardando mais jogadores (mínimo: 2)`;
            }
        }

        function adicionarHistorico(jogador, palavra, acertou, mensagem) {
            const lista = document.getElementById('lista-historico');
            const noHistory = lista.querySelector('.no-history');
            if (noHistory) noHistory.remove();

            const div = document.createElement('div');
            div.className = `history-item ${acertou ? 'success' : 'error'}`;

            const agora = new Date();
            const timestamp = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            const header = document.createElement('div');
            header.className = 'history-header';
            const spanPlayer = document.createElement('span');
            spanPlayer.className = 'history-player';
            spanPlayer.textContent = jogador;
            const spanTime = document.createElement('span');
            spanTime.className = 'history-time';
            spanTime.textContent = timestamp;
            header.appendChild(spanPlayer);
            header.appendChild(spanTime);

            const content = document.createElement('div');
            content.className = 'history-content';
            const word = document.createElement('div');
            word.className = 'history-word';
            word.textContent = `Tentativa: "${palavra}"`;
            const result = document.createElement('div');
            result.className = `history-result ${acertou ? 'success' : 'error'}`;
            result.textContent = mensagem;

            content.appendChild(word);
            content.appendChild(result);

            div.appendChild(header);
            div.appendChild(content);

            lista.insertBefore(div, lista.firstChild);
            while (lista.children.length > 20) {
                lista.removeChild(lista.lastChild);
            }
        }

        function adicionarMensagemChat(jogador, mensagem, timestamp) {
            const container = document.getElementById('mensagens-chat');
            const div = document.createElement('div');
            div.className = `chat-message ${jogador === meuNome ? 'own' : 'other'}`;

            const header = document.createElement('div');
            header.className = 'message-header';
            const spanNome = document.createElement('span');
            spanNome.textContent = jogador;
            const spanTime = document.createElement('span');
            spanTime.textContent = timestamp;
            header.appendChild(spanNome);
            header.appendChild(spanTime);

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = mensagem; // usa textContent para evitar XSS

            div.appendChild(header);
            div.appendChild(bubble);

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function limparInputTentativa() {
            document.getElementById('input-tentativa').value = '';
        }

        function mostrarSecao(secaoId) {
            // Esconder todas as seções
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            // Mostrar seção específica
            document.getElementById(secaoId).classList.remove('hidden');
        }

        function mostrarToast(mensagem, tipo = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.className = `toast ${tipo} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function copiarCodigo() {
            const codigo = document.getElementById('codigo-atual').textContent;
            navigator.clipboard.writeText(codigo).then(() => {
                mostrarToast('Código copiado!', 'success');
            }).catch(() => {
                mostrarToast('Erro ao copiar código', 'error');
            });
        }

        function sairDaSala() {
            if (confirm('Tem certeza que deseja sair da sala?')) {
                socket.emit('sair_da_sala', {
                    sala: codigoSala,
                    nome: meuNome
                });
                window.location.href = '/';
            }
        }

        function iniciarPartida() {
            if (confirm('Tem certeza que deseja iniciar a partida? Todos os jogadores atuais serão transferidos para definir suas palavras.')) {
                // Desabilitar botão temporariamente
                const botao = document.getElementById('btn-iniciar-partida');
                botao.disabled = true;
                botao.textContent = 'Iniciando partida...';
                
                socket.emit('iniciar_partida_manual', {
                    sala: codigoSala,
                    nome: meuNome
                });
            }
        }

        function alternarPronto() {
            // Verificar se é criador
            if (souCriador) {
                mostrarToast('O criador da sala não precisa marcar-se como pronto', 'warning');
                return;
            }
            
            estouPronto = !estouPronto;
            
            const botao = document.getElementById('btn-pronto');
            if (estouPronto) {
                botao.classList.remove('btn-success');
                botao.classList.add('btn-warning');
                botao.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    Cancelar Pronto
                `;
            } else {
                botao.classList.remove('btn-warning');
                botao.classList.add('btn-success');
                botao.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    Marcar como Pronto
                `;
            }
            
            // Enviar status para o servidor
            socket.emit('marcar_pronto', {
                sala: codigoSala,
                nome: meuNome,
                pronto: estouPronto
            });
        }

        function atualizarListaJogadoresComStatus(jogadores) {
            const container = document.getElementById('lista-jogadores-aguardando');
            if (!container) return;
            container.innerHTML = '';
            
            // Atualizar também o header
            const headerContainer = document.getElementById('lista-jogadores-header');
            if (headerContainer) headerContainer.innerHTML = '';
            
            // Identificar se eu sou o criador
            const euSouCriador = jogadores.find(j => j.nome === meuNome && j.criador);
            if (euSouCriador) {
                souCriador = true;
            }
            
            jogadores.forEach(jogador => {
                // Para o container principal de espera
                const chip = document.createElement('div');
                
                if (jogador.criador) {
                    // Criador: sem status de pronto
                    chip.className = 'player-chip criador';
                    chip.innerHTML = `👑 ${jogador.nome} (Criador)`;
                } else {
                    // Jogador normal: com status de pronto
                    chip.className = `player-chip ${jogador.pronto ? 'ready' : 'not-ready'}`;
                    const statusIcon = jogador.pronto ? '✅' : '⏳';
                    chip.innerHTML = `${statusIcon} ${jogador.nome}`;
                }
                
                container.appendChild(chip);
                
                // Também atualizar o header se não for meu nome
                if (jogador.nome !== meuNome && headerContainer) {
                    const headerChip = document.createElement('span');
                    headerChip.className = 'player-opponent';
                    headerChip.textContent = jogador.nome;
                    headerContainer.appendChild(headerChip);
                }
            });
            
            // Atualizar botões baseado no tipo de usuário
            atualizarBotoesBaseadoNoTipo(jogadores);
        }

        function atualizarBotaoIniciarPartida(totalNaoCriadores, jogadoresProntos, todosProntos = false) {
            const botao = document.getElementById('btn-iniciar-partida');
            const info = document.getElementById('iniciar-partida-info');
            if (!botao || !info) return;

            // Recalcular se parâmetros inválidos
            if (jogadoresProntos > totalNaoCriadores || totalNaoCriadores < 0) {
                const naoCriadores = (statusJogadores || []).filter(j => !j.criador);
                const prontosCalc = naoCriadores.filter(j => j.pronto).length;
                totalNaoCriadores = naoCriadores.length;
                jogadoresProntos = prontosCalc;
                todosProntos = totalNaoCriadores > 0 && jogadoresProntos === totalNaoCriadores;
            }

            if (!souCriador) {
                // Jogador normal: nunca habilita o botão
                document.getElementById('botao-iniciar-container').classList.add('hidden');
                document.getElementById('botao-pronto-container').classList.remove('hidden');
                return;
            }

            // Sou criador: mostrar botão iniciar
            document.getElementById('botao-pronto-container').classList.add('hidden');
            document.getElementById('botao-iniciar-container').classList.remove('hidden');

            if (totalNaoCriadores === 0) {
                botao.disabled = true;
                botao.classList.add('disabled');
                botao.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Aguardando Jogadores
                `;
                info.textContent = 'Aguarde outros jogadores entrarem na sala';
                return;
            }

            if (todosProntos) {
                botao.disabled = false;
                botao.classList.remove('disabled');
                botao.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    🚀 Iniciar Partida
                `;
                info.textContent = `Todos os ${totalNaoCriadores} jogadores estão prontos!`;
            } else {
                botao.disabled = true;
                botao.classList.add('disabled');
                botao.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    ⏳ Aguardando Jogadores (${jogadoresProntos}/${totalNaoCriadores})
                `;
                info.textContent = `Aguardando ${totalNaoCriadores - jogadoresProntos} jogador(es) ficarem prontos`;
            }
        }

        // Função de tema unificada
        function alterarTema(tema) {
            const root = document.documentElement;
            root.className = root.className
                .split(' ')
                .filter(c => !c.startsWith('theme-'))
                .join(' ')
                .trim();
            root.classList.add(tema);
            localStorage.setItem('tema', tema);
            mostrarToast(`Tema alterado para: ${tema.replace('theme-', '').charAt(0).toUpperCase() + tema.replace('theme-', '').slice(1)}`, 'success');
            toggleThemeMenu();
        }

        // Função para toggle do menu de temas
        function toggleThemeMenu() {
            const menu = document.getElementById('theme-menu');
            menu.classList.toggle('hidden');
        }

        // Fechar menu de temas ao clicar fora
        document.addEventListener('click', function (e) {
            const themeBtn = document.getElementById('theme-btn');
            const themeMenu = document.getElementById('theme-menu');

            if (!themeBtn.contains(e.target) && !themeMenu.contains(e.target)) {
                themeMenu.classList.add('hidden');
            }
        });

        // Função para expulsar jogador por nome
        function expulsarJogador(nomeJogador) {
            if (confirm(`Tem certeza que deseja expulsar ${nomeJogador}?`)) {
                socket.emit('expulsar_jogador', {
                    sala: codigoSala,
                    nome: nomeJogador
                });
            }
        }
    </script>
</body>

</html>