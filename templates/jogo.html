<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo das 5 Palavras - Sala</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <script>
        // Aplicar tema IMEDIATAMENTE quando o body √© carregado
        (function () {
            const temaSalvo = localStorage.getItem('tema') || 'theme-dark';
            document.documentElement.className = `game-body ${temaSalvo}`;
        })();
    </script>
</head>

<body>
    <div class="game-container">
        <!-- Header do Jogo -->
        <div class="game-header">
            <div class="game-info">
                <h1>Corrente Verbal</h1>
                <div class="players-info">
                    <span class="player-name" id="meu-nome"></span>
                    <span class="vs">vs</span>
                    <div class="players-list" id="lista-jogadores-header">
                        <!-- Os outros jogadores aparecer√£o aqui -->
                    </div>
                </div>
            </div>
            <div class="game-controls">
                <div class="theme-selector">
                    <button class="btn btn-secondary btn-small" onclick="toggleThemeMenu()" id="theme-btn">
                        üé® Tema
                    </button>
                    <div class="theme-menu-dropdown hidden" id="theme-menu">
                        <div class="theme-thumb" onclick="alterarTema('theme-light')" title="Claro">
                            <img src="/static/themes/sun.svg" alt="Claro">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-dark')" title="Escuro">
                            <img src="/static/themes/moon.svg" alt="Escuro">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-matrix')" title="Matrix">
                            <img src="/static/themes/matrix.svg" alt="Matrix">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-starwars')" title="Star Wars">
                            <img src="/static/themes/starwars.svg" alt="Star Wars">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-strangerthings')" title="Stranger Things">
                            <img src="/static/themes/strangerthings.svg" alt="Stranger Things">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-flamengo')" title="Flamengo">
                            <img src="/static/themes/flamengo.svg" alt="Flamengo">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-botafogo')" title="Botafogo">
                            <img src="/static/themes/botafogo.svg" alt="Botafogo">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-vasco')" title="Vasco">
                            <img src="/static/themes/vasco.svg" alt="Vasco">
                        </div>
                        <div class="theme-thumb" onclick="alterarTema('theme-fluminense')" title="Fluminense">
                            <img src="/static/themes/fluminense.svg" alt="Fluminense">
                        </div>
                    </div>
                </div>

                <button class="btn btn-danger btn-small" onclick="sairDaSala()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1">
                        </path>
                    </svg>
                    Sair
                </button>
            </div>
        </div>

        <!-- Indicador de Turno -->
        <div class="turn-indicator" id="indicador-turno">
            <div class="turn-content">
                <div class="turn-spinner hidden" id="spinner-turno"></div>
                <span id="texto-turno">Aguardando jogadores...</span>
            </div>
        </div>

        <!-- Se√ß√£o: Aguardando Jogadores -->
        <div class="section" id="secao-aguardando">
            <div class="card text-center">
                <h2>
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z">
                        </path>
                    </svg>
                    Aguardando Jogadores
                </h2>
                <div class="waiting-spinner"></div>
                <p id="status-sala">Conectando...</p>
                <!-- Lista de jogadores na sala de espera -->
                <div id="lista-jogadores-aguardando" class="players-list" style="justify-content: center; margin-top: 1rem; flex-wrap: wrap; gap: 0.5rem;"></div>
                
                <!-- Bot√£o para marcar-se como pronto -->
                <div id="botao-pronto-container" style="margin: 1rem 0;">
                    <button class="btn btn-success btn-large" onclick="alternarPronto()" id="btn-pronto">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        Marcar como Pronto
                    </button>
                    <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.9rem;" id="status-pronto-info">
                        Marque-se como pronto quando estiver preparado para jogar
                    </p>
                </div>
                
                <!-- Bot√£o para iniciar partida (apenas para o criador) -->
                <div id="botao-iniciar-container" class="hidden" style="margin: 1.5rem 0;">
                    <button class="btn btn-primary btn-large" onclick="iniciarPartida()" id="btn-iniciar-partida" disabled>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        Iniciar Partida
                    </button>
                    <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.9rem;" id="iniciar-partida-info">
                        Aguardando todos os jogadores ficarem prontos
                    </p>
                </div>
                
                <div class="room-code">
                    <span class="text-muted">C√≥digo da sala:</span>
                    <div class="code-display" id="codigo-atual"></div>
                    <button class="copy-btn" onclick="copiarCodigo()" title="Copiar c√≥digo">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                            </path>
                        </svg>
                    </button>
                </div>
                <div id="config-info" class="text-muted"></div>
            </div>
        </div>

        <!-- Se√ß√£o: Definir Palavras -->
        <div class="section hidden" id="secao-palavras">
            <div class="card">
                <h2>
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                        </path>
                    </svg>
                    Defina suas <span id="num-palavras-texto">5</span> palavras
                </h2>
                <p class="text-muted mb-3">Escolha palavras que seus advers√°rios ter√£o que adivinhar!</p>
                
                <!-- Aviso de m√≠nimo de jogadores -->
                <div class="alert alert-warning" id="aviso-min-jogadores">
                    Aguardando pelo menos 2 jogadores para iniciar o jogo...
                </div>

                <div class="words-input-container" id="container-palavras">
                    <!-- Inputs ser√£o gerados dinamicamente -->
                </div>

                <button class="btn btn-success btn-large" onclick="enviarPalavras()" id="btn-enviar-palavras">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Confirmar Palavras
                </button>
            </div>
        </div>

        <!-- Se√ß√£o: Jogo -->
        <div class="section hidden" id="secao-jogo">
            <div class="game-board-new">
                <!-- Coluna 1: Adivinha√ß√£o / Espelho -->
                <div class="guess-panel">
                    <h3 id="titulo-adivinhacao">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>

                        <span id="texto-titulo-adivinhacao">Sua Vez de Adivinhar</span>
                    </h3>

                    <div id="minha-vez" class="guess-controls">
                        <div class="current-word-display">
                            <div class="reference-word" id="palavra-referencia" style="display: none;">
                                <span class="reference-label">Palavra de Refer√™ncia:</span>
                                <span class="reference-value" id="valor-referencia">---</span>
                            </div>
                            <div class="word-hint-large" id="dica-atual">---</div>
                            <div class="word-progress" id="progresso-palavra">Palavra 1 de 5</div>
                        </div>

                        <div class="guess-input-group">
                            <input type="text" id="input-tentativa" placeholder="Digite sua tentativa..."
                                autocomplete="off">
                            <button class="btn btn-primary" onclick="tentarAdivinhar()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                                Tentar
                            </button>
                        </div>
                    </div>

                    <!-- Espelho do Jogador Ativo -->
                    <div id="espelho-jogador" class="mirror-view hidden">
                        <h3>
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Observando: <span id="mirror-player-name"></span>
                        </h3>

                        <p class="text-muted mb-2">Aguarde sua vez de jogar.</p>


                        <div class="current-word-display">
                            <div class="reference-word" id="mirror-palavra-referencia" style="display: none;">
                                <span class="reference-label">Palavra de Refer√™ncia:</span>
                                <span class="reference-value" id="mirror-valor-referencia">---</span>
                            </div>
                            <div class="word-hint-large" id="mirror-dica-atual">---</div>
                            <div class="word-progress" id="mirror-progresso-palavra">Palavra 1 de 5</div>
                        </div>

                        <div class="guess-input-group">
                            <input type="text" id="mirror-input-tentativa" placeholder="Seu palpite silencioso..."
                                autocomplete="off" disabled>
                            <button class="btn btn-secondary" disabled>
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Observando
                            </button>
                        </div>
                    </div>

                    <!-- Bot√µes de Emoji -->
                    <div class="emoji-reactions">
                        <h4>üé≠ Rea√ß√µes</h4>
                        <div class="emoji-buttons">
                            <button class="emoji-btn" onclick="enviarEmoji('üëç')" title="Gostei">üëç</button>
                            <button class="emoji-btn" onclick="enviarEmoji('üëé')" title="N√£o gostei">üëé</button>
                            <button class="emoji-btn" onclick="enviarEmoji('ü§î')" title="Pensativo">ü§î</button>
                            <button class="emoji-btn" onclick="enviarEmoji('üòÇ')" title="Rindo">üòÇ</button>
                            <button class="emoji-btn" onclick="enviarEmoji('üò±')" title="Surpreso">üò±</button>
                            <button class="emoji-btn" onclick="enviarEmoji('üî•')" title="Incr√≠vel">üî•</button>
                            <button class="emoji-btn" onclick="enviarEmoji('üí°')" title="Ideia">üí°</button>
                            <button class="emoji-btn" onclick="enviarEmoji('‚ù§Ô∏è')" title="Amei">‚ù§Ô∏è</button>
                        </div>
                    </div>
                </div>

                <!-- Coluna 2: Suas Palavras -->
                <div class="my-words-panel">
                    <h4>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                            </path>
                        </svg>
                        Suas Palavras (Alvo: <span id="meu-alvo">---</span>)
                    </h4>
                    <div class="words-grid" id="minhas-palavras-grid">
                        <!-- Palavras ser√£o geradas dinamicamente -->
                    </div>
                </div>

                <!-- Coluna 3: Todos os Jogadores -->
                <div class="all-players-panel">

                    <h4>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z">
                            </path>
                        </svg>
                        üë• Todos os Jogadores
                    </h4>
                    <div class="all-players-scroll" id="todos-jogadores-container">
                        <!-- Jogadores ser√£o gerados dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Hist√≥rico -->
            <div class="history-panel">
                <h3>
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Hist√≥rico de Tentativas
                </h3>
                <div class="history-list" id="lista-historico">
                    <div class="no-history">Nenhuma tentativa ainda</div>
                </div>
            </div>

            <!-- Chat -->
            <div class="chat-panel">
                <div class="chat-header">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                        </path>
                    </svg>
                    Chat
                </div>
                <div class="chat-messages" id="mensagens-chat">
                    <!-- Mensagens ser√£o adicionadas dinamicamente -->
                </div>
                <div class="chat-input">
                    <input type="text" id="input-chat" placeholder="Digite uma mensagem..." maxlength="200"
                        autocomplete="off">
                    <button class="btn btn-primary btn-small" onclick="enviarMensagem()">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Fim de Jogo -->
    <div id="modal-fim-jogo" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="titulo-fim-jogo">Fim de Jogo!</h2>
            </div>
            <div class="modal-body">
                <p id="mensagem-fim-jogo"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="voltarInicio()">Voltar ao In√≠cio</button>
                <button class="btn btn-secondary" onclick="fecharModalFim()">Continuar Conversando</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        // Vari√°veis globais
        let meuSid = null;
        let socket = null;
        let souCriador = false;
        let estouPronto = false;
        let statusJogadores = [];
        let salaEncontrada = false;
        let meuNome = '';
        let codigoSala = '';
        let numPalavras = 5;
        let estadoJogo = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function () {
            // Obter par√¢metros da URL
            const urlParams = new URLSearchParams(window.location.search);
            const pathParts = window.location.pathname.split('/');

            meuNome = urlParams.get('jogador') || '';
            codigoSala = pathParts[pathParts.length - 1] || '';
            numPalavras = parseInt(urlParams.get('num_palavras')) || 5;

            if (!meuNome || !codigoSala) {
                mostrarToast('Par√¢metros inv√°lidos. Redirecionando...', 'error');
                setTimeout(() => window.location.href = '/', 2000);
                return;
            }

            document.getElementById('meu-nome').textContent = meuNome;
            document.getElementById('codigo-atual').textContent = codigoSala;
            document.getElementById('num-palavras-texto').textContent = numPalavras;

            inicializarSocket();
            // gerarInputsPalavras() ser√° chamada quando necess√°rio, n√£o aqui
        });

        function inicializarSocket() {
            socket = io();

            socket.on('connect', function () {
                meuSid = socket.id;
                console.log('Conectado ao servidor, meuSid:', meuSid);

                // A sala j√° foi criada na p√°gina inicial.
                // Ao carregar esta p√°gina, o objetivo √© sempre ENTRAR na sala.
                console.log(`Tentando entrar na sala: ${codigoSala} com nome: ${meuNome}`);
                socket.emit('entrar_na_sala', {
                    sala: codigoSala,
                    nome: meuNome
                });
                
                // Gerar inputs ap√≥s um pequeno delay para garantir que tudo esteja pronto
                setTimeout(() => {
                    gerarInputsPalavras();
                }, 100);
                
                // Configurar um timeout caso n√£o receba resposta em 5 segundos
                setTimeout(function() {
                    if (!salaEncontrada) {
                        mostrarToast('N√£o foi poss√≠vel conectar √† sala. Verifique o c√≥digo e tente novamente.', 'error');
                        setTimeout(function() {
                            window.location.href = '/';
                        }, 3000);
                    }
                }, 5000);
            });

            // Listener para emojis recebidos
            socket.on('emoji_recebido', function (data) {
                console.log('Emoji recebido:', data);
                criarEmojiFlutante(data.emoji, data.nome);
            });

            socket.on('disconnect', function () {
                console.log('Desconectado do servidor');
                mostrarToast('Conex√£o perdida. Tentando reconectar automaticamente...', 'warning');
                
                // Tentativas de reconex√£o com backoff exponencial
                let tentativas = 0;
                const tentarReconectar = function() {
                    if (!socket.connected && tentativas < 10) {
                        setTimeout(function() {
                            tentativas++;
                            mostrarToast(`Tentando reconectar (${tentativas}/10)...`, 'warning');
                            socket.connect();
                            
                            if (!socket.connected) {
                                // Aumentar tempo entre tentativas (backoff exponencial)
                                tentarReconectar();
                            }
                        }, Math.min(1000 * Math.pow(1.5, tentativas), 10000)); // M√°ximo 10 segundos
                    } else if (!socket.connected) {
                        mostrarToast('Falha na reconex√£o. Atualize a p√°gina.', 'error');
                    }
                };
                
                tentarReconectar();
            });

            // Eventos do jogo
            socket.on('sala_criada', function(data) {
                console.log('[DEBUG] Sala criada:', data);
                souCriador = true;
                salaEncontrada = true;
                mostrarSecao('secao-aguardando');
                atualizarBotaoIniciarPartida(1, data.max_jogadores || 10);
            });

            socket.on('jogador_entrou', function(data) {
                console.log('[DEBUG] Jogador entrou:', data);
                salaEncontrada = true; // Marcar que encontrou a sala
                
                // Se recebeu flag sou_criador, atualizar
                if ('sou_criador' in data) {
                    souCriador = data.sou_criador;
                    console.log(`[DEBUG] Status de criador atualizado via jogador_entrou: ${souCriador}`);
                }
                
                // Atualizar informa√ß√µes da sala
                totalJogadores = data.total;
                maxJogadores = data.max;
                
                // Atualizar lista com informa√ß√µes de status pronto
                if (data.jogadores_info) {
                    statusJogadores = data.jogadores_info;
                    atualizarListaJogadoresComStatus(data.jogadores_info);
                } else {
                    atualizarListaJogadoresAguardando(data.jogadores);
                }
                
                // Atualizar interface baseada no tipo de usu√°rio
                atualizarBotoesBaseadoNoTipo(statusJogadores || []);
                
                atualizarBotaoIniciarPartida(data.total, data.max, data.todos_prontos);
                
                // Atualizar informa√ß√µes da configura√ß√£o
                const configInfo = document.getElementById('config-info');
                if (configInfo) {
                    configInfo.textContent = `${data.total}/${data.max} jogadores`;
                }
            });

            // Novo evento para atualiza√ß√£o de status de prontos
            socket.on('status_prontos_atualizado', function(data) {
                console.log('[DEBUG] Status prontos atualizado:', data);
                statusJogadores = data.jogadores;
                atualizarListaJogadoresComStatus(data.jogadores);
                atualizarBotaoIniciarPartida(data.total_jogadores, 10, data.todos_prontos);
                
                // Atualizar info de status
                const prontos = data.jogadores_prontos;
                const total = data.total_jogadores;
                document.getElementById('status-pronto-info').textContent = 
                    `${prontos}/${total} jogadores prontos`;
            });

            socket.on('pode_comecar', function (data) {
                console.log('Pode come√ßar:', data);
                document.getElementById('status-sala').textContent = data.msg;
                atualizarListaJogadoresAguardando(data.jogadores || []);

                // Ocultar bot√µes de iniciar partida e pronto quando a partida come√ßa
                document.getElementById('botao-iniciar-container').classList.add('hidden');
                document.getElementById('botao-pronto-container').classList.add('hidden');

                // Atualizar configura√ß√£o para todos os jogadores
                if (data.num_palavras) {
                    numPalavras = data.num_palavras;
                    document.getElementById('num-palavras-texto').textContent = numPalavras;
                    gerarInputsPalavras(); // Regenerar com o n√∫mero correto
                }

                // Mostrar se√ß√£o de palavras
                mostrarSecao('secao-palavras');
            });

            socket.on('status_palavras_atualizado', function (data) {
                console.log('Status palavras atualizado:', data);
                mostrarToast(data.msg, 'info');
                
                // Verificar se h√° jogadores pendentes
                if (data.jogadores_pendentes && data.jogadores_pendentes.length > 0) {
                    const mensagem = `Aguardando palavras de: ${data.jogadores_pendentes.join(', ')}`;
                    document.getElementById('status-sala').textContent = mensagem;
                }
                
                if (data.status_jogadores) {
                    atualizarStatusPalavras(data.status_jogadores);
                }
            });

            socket.on('palavras_recebidas', function (data) {
                console.log('Palavras recebidas:', data);
                mostrarToast(data.msg, 'success');
                document.getElementById('btn-enviar-palavras').disabled = true;
                document.getElementById('btn-enviar-palavras').textContent = 'Palavras Enviadas ‚úì';
            });

            socket.on('jogo_iniciado', function (data) {
                console.log('Jogo iniciado:', data);
                mostrarToast(data.msg, 'success');
                estadoJogo = data.estado;
                const criadorSid = estadoJogo.criador;
                // meuSid j√° est√° definido globalmente
                mostrarSecao('secao-jogo');
                atualizarInterfaceJogo();
            });

            socket.on('jogador_saiu', function (data) {
                console.log('Jogador saiu:', data);
                mostrarToast(data.msg, 'info');
                
                // Atualizar lista de jogadores
                if (data.jogadores_restantes) {
                    atualizarListaJogadoresAguardando(data.jogadores_restantes);
                    // Atualizar bot√£o de iniciar partida se estamos na sala de espera
                    if (!estadoJogo) {
                        atualizarBotaoIniciarPartida(data.jogadores_restantes.length, 10); // Assumindo m√°ximo de 10
                    }
                }
            });

            socket.on('resposta_tentativa', function (data) {
                console.log('Resposta tentativa:', data);
                estadoJogo = data.estado;

                adicionarHistorico(data.jogador, data.palavra_tentada, data.acertou, data.mensagem);

                if (data.acertou) {
                    mostrarToast(`${data.jogador}: ${data.mensagem}`, 'success');
                } else {
                    mostrarToast(`${data.jogador}: ${data.mensagem}`, 'error');
                }

                atualizarInterfaceJogo();
                limparInputTentativa();
            });

            socket.on('fim_de_jogo', function (data) {
                console.log('Fim de jogo:', data);
                document.getElementById('titulo-fim-jogo').textContent = 'üéâ Fim de Jogo!';
                document.getElementById('mensagem-fim-jogo').innerHTML = `
                    <div class="winner-announcement">${data.mensagem}</div>
                    <div class="loading-gabarito">
                        <div class="spinner"></div>
                        <p>Carregando gabarito...</p>
                    </div>
                `;
                document.getElementById('modal-fim-jogo').classList.remove('hidden');
                mostrarToast(data.mensagem, 'success');

                // Solicitar gabarito completo
                socket.emit('obter_gabarito', { sala: codigoSala });
            });

            socket.on('gabarito_completo', function (data) {
                console.log('Gabarito completo:', data);
                exibirGabarito(data.gabarito);
            });

            socket.on('jogo_reiniciado', function (data) {
                console.log('Jogo reiniciado:', data);
                mostrarToast(data.msg, 'success');

                // Resetar interface
                estadoJogo = null;
                document.getElementById('modal-fim-jogo').classList.add('hidden');

                // Voltar para se√ß√£o de definir palavras
                mostrarSecao('secao-palavras');

                // Resetar bot√£o de enviar palavras
                const btnEnviar = document.getElementById('btn-enviar-palavras');
                btnEnviar.disabled = false;
                btnEnviar.textContent = 'Confirmar Palavras';
                btnEnviar.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Confirmar Palavras
                `;

                // Limpar inputs de palavras
                for (let i = 1; i <= numPalavras; i++) {
                    const input = document.getElementById(`palavra-${i}`);
                    if (input) input.value = '';
                }

                // Limpar hist√≥rico e chat
                document.getElementById('lista-historico').innerHTML = '<div class="no-history">Nenhuma tentativa ainda</div>';
                document.getElementById('mensagens-chat').innerHTML = '';
            });

            socket.on('nova_mensagem_chat', function (data) {
                console.log('Nova mensagem chat:', data);
                adicionarMensagemChat(data.jogador, data.mensagem, data.timestamp);
            });

            socket.on('erro', function (data) {
                console.error('Erro:', data);
                mostrarToast(data.msg, 'error');
                
                // Se for erro de sala n√£o encontrada, redirecionar ap√≥s um tempo
                if (data.msg && data.msg.includes('Sala n√£o encontrada')) {
                    setTimeout(function() {
                        mostrarToast('Redirecionando para a p√°gina inicial...', 'info');
                        setTimeout(function() {
                            window.location.href = '/';
                        }, 2000);
                    }, 3000);
                }
            });

            socket.on('error', function (data) {
                console.error('Error:', data);
                mostrarToast(data.msg, 'error');
                
                // Reabilitar bot√£o de iniciar partida se houve erro
                const botao = document.getElementById('btn-iniciar-partida');
                if (botao && data.msg && data.msg.includes('pronto')) {
                    botao.disabled = true;
                    botao.innerHTML = `
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        ‚è≥ Aguardando Jogadores
                    `;
                }
            });
            
            // Ouvir mensagens de aviso (n√£o s√£o erros, mas informa√ß√µes importantes)
            socket.on('aviso', function (data) {
                console.log('Aviso:', data);
                mostrarToast(data.msg, 'warning');
                
                // Se o aviso cont√©m informa√ß√£o sobre o criador ter sa√≠do, atualizar a interface
                if (data.msg && data.msg.includes('criador da sala')) {
                    document.getElementById('status-sala').textContent += ' (Criador saiu)';
                }
            });

            // Novo evento para processar status do usu√°rio
            socket.on('meu_status', function(data) {
                console.log('[DEBUG] Meu status recebido:', data);
                
                // Atualizar vari√°veis globais
                souCriador = data.sou_criador;
                meuNome = data.nome;
                codigoSala = data.sala;
                
                console.log(`[DEBUG] Configurado: souCriador=${souCriador}, nome=${meuNome}`);
                
                // Atualizar interface baseada no status
                if (statusJogadores && statusJogadores.length > 0) {
                    atualizarBotoesBaseadoNoTipo(statusJogadores);
                }
            });
        }

        function gerarInputsPalavras() {
            if (!numPalavras || numPalavras <= 0) {
                console.log('NumPalavras n√£o definido ainda');
                return;
            }
            
            const container = document.getElementById('container-palavras');
            if (!container) {
                console.log('Container de palavras n√£o encontrado!');
                return;
            }
            
            container.innerHTML = '';
            
            for (let i = 1; i <= numPalavras; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `palavra-${i}`;
                input.placeholder = `Palavra ${i}`;
                input.maxLength = 20;
                input.required = true;
                input.className = 'form-input';
                
                container.appendChild(input);
            }
        }

        function enviarPalavras() {
            const palavras = [];
            let todasPreenchidas = true;

            for (let i = 1; i <= numPalavras; i++) {
                const input = document.getElementById(`palavra-${i}`);
                const palavra = input.value.trim();

                if (!palavra) {
                    mostrarToast(`Por favor, preencha a palavra ${i}`, 'error');
                    input.focus();
                    return;
                }

                if (palavra.length < 2) {
                    mostrarToast(`A palavra ${i} deve ter pelo menos 2 letras`, 'error');
                    input.focus();
                    return;
                }

                if (!/^[a-zA-Z√Ä-√ø\s]+$/.test(palavra)) {
                    mostrarToast(`A palavra ${i} deve conter apenas letras`, 'error');
                    input.focus();
                    return;
                }

                palavras.push(palavra);
            }

            socket.emit('enviar_palavras', {
                sala: codigoSala,
                nome: meuNome,
                palavras: palavras
            });
        }

        function tentarAdivinhar() {
            const input = document.getElementById('input-tentativa');
            const palavra = input.value.trim();

            if (!palavra) {
                mostrarToast('Digite uma palavra para tentar!', 'error');
                input.focus();
                return;
            }

            socket.emit('tentar_adivinhar', {
                sala: codigoSala,
                nome: meuNome,
                palavra: palavra
            });
        }

        function enviarMensagem() {
            const input = document.getElementById('input-chat');
            const mensagem = input.value.trim();

            if (!mensagem) return;

            socket.emit('enviar_mensagem_chat', {
                sala: codigoSala,
                nome: meuNome,
                mensagem: mensagem
            });

            input.value = '';
        }

        function atualizarInterfaceJogo() {
            if (!estadoJogo) return;

            // Atualizar indicador de turno
            const indicador = document.getElementById('indicador-turno');
            const textoTurno = document.getElementById('texto-turno');
            const minhaVez = document.getElementById('minha-vez');

            if (estadoJogo.jogador_da_vez === meuNome) {
                indicador.className = 'turn-indicator my-turn';
                textoTurno.textContent = 'Sua vez de jogar!';
                if (minhaVez) minhaVez.classList.remove('hidden');
            } else {
                indicador.className = 'turn-indicator opponent-turn';
                textoTurno.textContent = `Vez de ${estadoJogo.jogador_da_vez}`;
                if (minhaVez) minhaVez.classList.add('hidden');
            }

            // Encontrar meus dados e do meu alvo
            const meusDados = estadoJogo.jogadores.find(j => j.nome === meuNome);
            if (meusDados) {
                const meuAlvoElem = document.getElementById('meu-alvo');
                const dicaAtualElem = document.getElementById('dica-atual');
                const progressoPalavraElem = document.getElementById('progresso-palavra');
                
                if (meuAlvoElem) meuAlvoElem.textContent = meusDados.alvo;
                if (dicaAtualElem) dicaAtualElem.textContent = meusDados.dica_atual || '---';
                if (progressoPalavraElem) {
                    progressoPalavraElem.textContent = `Palavra ${meusDados.palavra_atual_index + 1} de ${estadoJogo.config.num_palavras}`;
                }

                // Atualizar palavra de refer√™ncia
                const palavraReferencia = document.getElementById('palavra-referencia');
                const valorReferencia = document.getElementById('valor-referencia');

                if (palavraReferencia && valorReferencia) {
                    if (meusDados.palavra_anterior && meusDados.palavra_anterior.trim()) {
                        palavraReferencia.style.display = 'block';
                        valorReferencia.textContent = meusDados.palavra_anterior;
                    } else {
                        palavraReferencia.style.display = 'none';
                    }
                }
            }

            // Atualizar minhas palavras (como alvo)
            const meuAlvo = estadoJogo.jogadores.find(j => j.nome === meusDados?.alvo);
            if (meuAlvo) {
                atualizarGridPalavras('minhas-palavras-grid', meuAlvo, true);
            }

            // Atualizar todos os jogadores
            atualizarTodosJogadores();

            // Atualizar lista de jogadores no header
            const jogadores = estadoJogo.jogadores.map(j => j.nome);
            atualizarListaJogadores(jogadores);
        }

        function atualizarGridPalavras(gridId, dadosJogador, saoMinhasPalavras) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            for (let i = 0; i < estadoJogo.config.num_palavras; i++) {
                const div = document.createElement('div');
                div.className = 'word-card';

                // Determinar se a palavra foi descoberta
                const descoberta = dadosJogador.palavras_descobertas && dadosJogador.palavras_descobertas[i];

                if (descoberta) {
                    div.classList.add('discovered');
                } else {
                    div.classList.add('not-discovered');
                }

                const dica = dadosJogador.dicas && dadosJogador.dicas[i] ? dadosJogador.dicas[i] : '?';
                const status = descoberta ? '‚úì' : '';

                div.innerHTML = `
                    <div class="word-number">${i + 1}</div>
                    <div class="word-hint">${dica}</div>
                    <div class="word-status">${status}</div>
                `;

                grid.appendChild(div);
            }
        }

        function atualizarListaJogadores(jogadores) {
            const lista = document.getElementById('lista-jogadores-header');
            lista.innerHTML = '';

            // Filtrar para mostrar apenas os outros jogadores (n√£o o pr√≥prio usu√°rio)
            const outrosJogadores = jogadores.filter(jogador => jogador !== meuNome);

            outrosJogadores.forEach(jogador => {
                const span = document.createElement('span');
                span.className = 'player-chip';
                span.textContent = jogador;

                // Destacar quem est√° na vez
                if (estadoJogo && estadoJogo.jogador_da_vez === jogador) {
                    span.classList.add('target');
                }

                lista.appendChild(span);
            });
        }

        function atualizarListaJogadoresAguardando(jogadores) {
            const container = document.getElementById('lista-jogadores-aguardando');
            if (!container) return;
            container.innerHTML = '';
            
            // Atualizar tamb√©m o header
            const headerContainer = document.getElementById('lista-jogadores-header');
            if (headerContainer) headerContainer.innerHTML = '';
            
            jogadores.forEach(nome => {
                // Para o container principal de espera
                const chip = document.createElement('div');
                chip.className = 'player-chip';
                // Adiciona um √≠cone para cada jogador na lista de espera
                chip.innerHTML = `üë§ ${nome}`;
                container.appendChild(chip);
                
                // Tamb√©m atualizar o header se n√£o for meu nome
                if (nome !== meuNome && headerContainer) {
                    const headerChip = document.createElement('span');
                    headerChip.className = 'player-opponent';
                    headerChip.textContent = nome;
                    headerContainer.appendChild(headerChip);
                }
            });
            
            // Mostrar quantos jogadores est√£o na sala
            if (jogadores.length >= 2) {
                document.getElementById('status-sala').innerHTML = 
                    `<span class="ready-status">‚úÖ ${jogadores.length} jogadores conectados - Prontos para jogar!</span>`;
            } else {
                document.getElementById('status-sala').textContent = 
                    `Aguardando mais jogadores (m√≠nimo: 2)`;
            }
        }

        function adicionarHistorico(jogador, palavra, acertou, mensagem) {
            const lista = document.getElementById('lista-historico');

            // Remover mensagem "nenhuma tentativa"
            const noHistory = lista.querySelector('.no-history');
            if (noHistory) {
                noHistory.remove();
            }

            const div = document.createElement('div');
            div.className = `history-item ${acertou ? 'success' : 'error'}`;

            const agora = new Date();
            const timestamp = agora.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            div.innerHTML = `
                <div class="history-header">
                    <span class="history-player">${jogador}</span>
                    <span class="history-time">${timestamp}</span>
                </div>
                <div class="history-content">
                    <div class="history-word">Tentativa: "${palavra}"</div>
                    <div class="history-result ${acertou ? 'success' : 'error'}">${mensagem}</div>
                </div>
            `;

            lista.insertBefore(div, lista.firstChild);

            // Limitar hist√≥rico a 20 itens
            while (lista.children.length > 20) {
                lista.removeChild(lista.lastChild);
            }
        }

        function adicionarMensagemChat(jogador, mensagem, timestamp) {
            const container = document.getElementById('mensagens-chat');

            const div = document.createElement('div');
            div.className = `chat-message ${jogador === meuNome ? 'own' : 'other'}`;

            div.innerHTML = `
                <div class="message-header">
                    <span>${jogador}</span>
                    <span>${timestamp}</span>
                </div>
                <div class="message-bubble">${mensagem}</div>
            `;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function limparInputTentativa() {
            document.getElementById('input-tentativa').value = '';
        }

        function mostrarSecao(secaoId) {
            // Esconder todas as se√ß√µes
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            // Mostrar se√ß√£o espec√≠fica
            document.getElementById(secaoId).classList.remove('hidden');
        }

        function mostrarToast(mensagem, tipo = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.className = `toast ${tipo} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function copiarCodigo() {
            const codigo = document.getElementById('codigo-atual').textContent;
            navigator.clipboard.writeText(codigo).then(() => {
                mostrarToast('C√≥digo copiado!', 'success');
            }).catch(() => {
                mostrarToast('Erro ao copiar c√≥digo', 'error');
            });
        }

        function sairDaSala() {
            if (confirm('Tem certeza que deseja sair da sala?')) {
                socket.emit('sair_da_sala', {
                    sala: codigoSala,
                    nome: meuNome
                });
                window.location.href = '/';
            }
        }

        function iniciarPartida() {
            if (confirm('Tem certeza que deseja iniciar a partida? Todos os jogadores atuais ser√£o transferidos para definir suas palavras.')) {
                // Desabilitar bot√£o temporariamente
                const botao = document.getElementById('btn-iniciar-partida');
                botao.disabled = true;
                botao.textContent = 'Iniciando partida...';
                
                socket.emit('iniciar_partida_manual', {
                    sala: codigoSala,
                    nome: meuNome
                });
            }
        }

        function alternarPronto() {
            // Verificar se √© criador
            if (souCriador) {
                mostrarToast('O criador da sala n√£o precisa marcar-se como pronto', 'warning');
                return;
            }
            
            estouPronto = !estouPronto;
            
            const botao = document.getElementById('btn-pronto');
            if (estouPronto) {
                botao.classList.remove('btn-success');
                botao.classList.add('btn-warning');
                botao.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    Cancelar Pronto
                `;
            } else {
                botao.classList.remove('btn-warning');
                botao.classList.add('btn-success');
                botao.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    Marcar como Pronto
                `;
            }
            
            // Enviar status para o servidor
            socket.emit('marcar_pronto', {
                sala: codigoSala,
                nome: meuNome,
                pronto: estouPronto
            });
        }

        function atualizarListaJogadoresComStatus(jogadores) {
            const container = document.getElementById('lista-jogadores-aguardando');
            if (!container) return;
            container.innerHTML = '';
            
            // Atualizar tamb√©m o header
            const headerContainer = document.getElementById('lista-jogadores-header');
            if (headerContainer) headerContainer.innerHTML = '';
            
            // Identificar se eu sou o criador
            const euSouCriador = jogadores.find(j => j.nome === meuNome && j.criador);
            if (euSouCriador) {
                souCriador = true;
            }
            
            jogadores.forEach(jogador => {
                // Para o container principal de espera
                const chip = document.createElement('div');
                
                if (jogador.criador) {
                    // Criador: sem status de pronto
                    chip.className = 'player-chip criador';
                    chip.innerHTML = `üëë ${jogador.nome} (Criador)`;
                } else {
                    // Jogador normal: com status de pronto
                    chip.className = `player-chip ${jogador.pronto ? 'ready' : 'not-ready'}`;
                    const statusIcon = jogador.pronto ? '‚úÖ' : '‚è≥';
                    chip.innerHTML = `${statusIcon} ${jogador.nome}`;
                }
                
                container.appendChild(chip);
                
                // Tamb√©m atualizar o header se n√£o for meu nome
                if (jogador.nome !== meuNome && headerContainer) {
                    const headerChip = document.createElement('span');
                    headerChip.className = 'player-opponent';
                    headerChip.textContent = jogador.nome;
                    headerContainer.appendChild(headerChip);
                }
            });
            
            // Atualizar bot√µes baseado no tipo de usu√°rio
            atualizarBotoesBaseadoNoTipo(jogadores);
        }

        function atualizarBotaoIniciarPartida(totalJogadores, jogadoresProntos, todosProntos = false) {
            console.log(`[DEBUG] atualizarBotaoIniciarPartida: total=${totalJogadores}, prontos=${jogadoresProntos}, todosProntos=${todosProntos}`);
            
            const botao = document.getElementById('btn-iniciar-partida');
            const info = document.getElementById('iniciar-partida-info');
            
            if (!botao || !info) {
                console.log('[DEBUG] Elementos do bot√£o n√£o encontrados no DOM');
                return;
            }
            
            if (totalJogadores === 0) {
                // S√≥ tem o criador na sala
                botao.disabled = true;
                botao.style.backgroundColor = '#ccc';
                botao.style.opacity = '0.6';
                botao.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    Aguardando Jogadores
                `;
                info.textContent = 'Aguarde outros jogadores entrarem na sala';
                info.style.color = '#666';
            } else if (todosProntos) {
                // Todos os jogadores est√£o prontos
                botao.disabled = false;
                botao.style.backgroundColor = '#4CAF50';
                botao.style.opacity = '1';
                botao.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    üöÄ Iniciar Partida
                `;
                info.textContent = `Todos os ${totalJogadores} jogadores est√£o prontos!`;
                info.style.color = '#4CAF50';
            } else {
                // Nem todos est√£o prontos
                botao.disabled = true;
                botao.style.backgroundColor = '#ccc';
                botao.style.opacity = '0.6';
                botao.innerHTML = `
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    ‚è≥ Aguardando Jogadores (${jogadoresProntos}/${totalJogadores})
                `;
                info.textContent = `Aguardando ${totalJogadores - jogadoresProntos} jogador(es) ficarem prontos`;
                info.style.color = '#666';
            }
        }

        function voltarInicio() {
            window.location.href = '/';
        }

        function exibirGabarito(gabarito) {
            let gabaritoHtml = '<div class="gabarito-completo">';
            gabaritoHtml += '<h3>üìù Gabarito Completo</h3>';

            for (const [jogador, dados] of Object.entries(gabarito)) {
                gabaritoHtml += `
                    <div class="player-answers">
                        <h4>Palavras de ${jogador}:</h4>
                        <ol class="answer-list">
                `;

                for (let i = 0; i < dados.palavras_originais.length; i++) {
                    const palavraOriginal = dados.palavras_originais[i];
                    const palavraNormalizada = dados.palavras_normalizadas[i];
                    const descoberta = dados.descobertas[i];

                    let statusIcon = descoberta ? '‚úÖ' : '‚ùå';
                    let correcaoInfo = '';

                    // Mostrar se houve corre√ß√£o autom√°tica
                    if (palavraOriginal.toLowerCase() !== palavraNormalizada.toLowerCase()) {
                        correcaoInfo = ` <span class="correction-info">(corrigido de "${palavraOriginal}")</span>`;
                    }

                    gabaritoHtml += `
                        <li class="answer-item ${descoberta ? 'discovered' : 'not-discovered'}">
                            ${statusIcon} <strong>${palavraNormalizada}</strong>${correcaoInfo}
                        </li>
                    `;
                }

                gabaritoHtml += '</ol></div>';
            }

            gabaritoHtml += '</div>';

            // Atualizar modal com gabarito e bot√µes
            document.getElementById('mensagem-fim-jogo').innerHTML = `
                <div class="winner-announcement">üéâ ${estadoJogo?.vencedor || 'Algu√©m'} venceu!</div>
                ${gabaritoHtml}
            `;

            // Atualizar bot√µes do modal
            document.querySelector('.modal-footer').innerHTML = `
                <button class="btn btn-success" onclick="novoJogo()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    üéÆ Novo Jogo
                </button>
                <button class="btn btn-primary" onclick="voltarInicio()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    üè† In√≠cio
                </button>
                <button class="btn btn-secondary" onclick="fecharModalFim()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    üí¨ Chat
                </button>
            `;
        }

        function novoJogo() {
            if (confirm('Tem certeza que deseja iniciar um novo jogo? Todos os jogadores ter√£o que definir novas palavras.')) {
                socket.emit('novo_jogo', {
                    sala: codigoSala,
                    nome: meuNome
                });
            }
        }

        function fecharModalFim() {
            document.getElementById('modal-fim-jogo').classList.add('hidden');
        }

        // Sistema de Emojis Flutuantes
        function enviarEmoji(emoji) {
            // Enviar emoji via socket - N√ÉO criar localmente, deixar o servidor retornar
            socket.emit('enviar_emoji', {
                sala: codigoSala,
                nome: meuNome,
                emoji: emoji
            });
        }

        function criarEmojiFlutante(emoji, jogador) {
            const container = document.querySelector('.game-container');
            const emojiElement = document.createElement('div');
            emojiElement.className = 'floating-emoji';
            emojiElement.innerHTML = `
                <div class="emoji-content">
                    <span class="emoji-icon">${emoji}</span>
                </div>
            `;

            // Posi√ß√£o aleat√≥ria horizontal
            emojiElement.style.left = Math.random() * 80 + 10 + "%";
            emojiElement.style.bottom = "0px";

            container.appendChild(emojiElement);

            // Inicia a anima√ß√£o (for√ßando reflow)
            setTimeout(() => {
                emojiElement.style.bottom = "100vh";
                emojiElement.style.opacity = "0";
            }, 10);

            // Remove depois da anima√ß√£o
            setTimeout(() => {
                container.removeChild(emojiElement);
            }, 3000);
        }

        // Atualizar espelho do jogador ativo
        function atualizarEspelhoJogador() {
            if (!estadoJogo) return;

            const minhaVez = document.getElementById('minha-vez');
            const espelhoJogador = document.getElementById('espelho-jogador');
            const tituloAdivinhacao = document.getElementById('texto-titulo-adivinhacao');

            if (estadoJogo.jogador_da_vez === meuNome) {
                // √â minha vez - mostrar controles normais
                if (minhaVez) minhaVez.classList.remove('hidden');
                if (espelhoJogador) espelhoJogador.classList.add('hidden');
                if (tituloAdivinhacao) tituloAdivinhacao.textContent = 'Sua Vez de Adivinhar';
            } else {
                // N√£o √© minha vez - mostrar espelho
                if (minhaVez) minhaVez.classList.add('hidden');
                if (espelhoJogador) espelhoJogador.classList.remove('hidden');
                if (tituloAdivinhacao) tituloAdivinhacao.textContent = 'Observando o Jogo';

                // Encontrar dados do jogador ativo
                const jogadorAtivo = estadoJogo.jogadores.find(j => j.nome === estadoJogo.jogador_da_vez);
                if (jogadorAtivo) {
                    const mirrorPlayerName = document.getElementById('mirror-player-name');
                    const mirrorDicaAtual = document.getElementById('mirror-dica-atual');
                    const mirrorProgressoPalavra = document.getElementById('mirror-progresso-palavra');
                    
                    if (mirrorPlayerName) mirrorPlayerName.textContent = jogadorAtivo.nome;
                    if (mirrorDicaAtual) mirrorDicaAtual.textContent = jogadorAtivo.dica_atual || '---';
                    if (mirrorProgressoPalavra) {
                        mirrorProgressoPalavra.textContent = `Palavra ${jogadorAtivo.palavra_atual_index + 1} de ${estadoJogo.config.num_palavras}`;
                    }

                    // Palavra de refer√™ncia no espelho
                    const mirrorPalavraReferencia = document.getElementById('mirror-palavra-referencia');
                    const mirrorValorReferencia = document.getElementById('mirror-valor-referencia');

                    if (mirrorPalavraReferencia && mirrorValorReferencia) {
                        if (jogadorAtivo.palavra_anterior && jogadorAtivo.palavra_anterior.trim()) {
                            mirrorPalavraReferencia.style.display = 'block';
                            mirrorValorReferencia.textContent = jogadorAtivo.palavra_anterior;
                        } else {
                            mirrorPalavraReferencia.style.display = 'none';
                        }
                    }
                }
            }
        }

        // Atualizar painel de todos os jogadores
        function atualizarTodosJogadores() {
            if (!estadoJogo) return;

            const container = document.getElementById('todos-jogadores-container');
            container.innerHTML = '';
            
            // Verificar se sou o criador
            const sou_criador = estadoJogo.criador === socket.id;

            estadoJogo.jogadores.forEach(jogador => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-section';

                // √çcone especial para jogador ativo
                const icone = jogador.nome === estadoJogo.jogador_da_vez ? 'üéÆ' : 'üë§';
                const status = jogador.nome === estadoJogo.jogador_da_vez ? ' (Jogando)' : '';

                // Contar palavras descobertas pelo jogador (palavras do seu alvo)
                const descobertas = jogador.palavras_descobertas ?
                    jogador.palavras_descobertas.filter(d => d).length : 0;
                const total = estadoJogo.config.num_palavras;

                // Encontrar quem √© o alvo deste jogador
                const nomeAlvo = jogador.alvo || '---';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'player-header';
                headerDiv.innerHTML = `
                    <h5>${icone} ${jogador.nome}${status}</h5>
                    <span class="player-progress">${descobertas}/${total}</span>
                `;
                
                // Se sou o criador e n√£o √© meu pr√≥prio nome, adicionar bot√£o de expulsar
                if (sou_criador && jogador.nome !== meuNome) {
                    const btnExpulsar = document.createElement('button');
                    btnExpulsar.className = 'btn btn-sm btn-danger';
                    btnExpulsar.innerHTML = 'üõë';
                    btnExpulsar.title = 'Expulsar jogador';
                    btnExpulsar.onclick = () => expulsarJogador(jogador.nome);
                    headerDiv.appendChild(btnExpulsar);
                }
                
                playerDiv.appendChild(headerDiv);

                // Resto do conte√∫do do jogador
                playerDiv.innerHTML += `
                    <div class="player-target-info">
                        <span class="target-label">Adivinhando palavras de:</span>
                        <span class="target-name">${nomeAlvo}</span>
                    </div>
                    <div class="player-words-grid" id="player-${jogador.nome.replace(/\s+/g, '_')}-grid">
                        <!-- Palavras ser√£o geradas -->
                    </div>
                `;

                container.appendChild(playerDiv);

                // Gerar grid de palavras para este jogador (palavras do seu alvo)
                const grid = document.getElementById(`player-${jogador.nome.replace(/\s+/g, '_')}-grid`);
                for (let i = 0; i < total; i++) {
                    const wordDiv = document.createElement('div');
                    wordDiv.className = 'mini-word-card';

                    const descoberta = jogador.palavras_descobertas && jogador.palavras_descobertas[i];
                    const dica = jogador.dicas && jogador.dicas[i] ? jogador.dicas[i] : '?';

                    if (descoberta) {
                        wordDiv.classList.add('discovered');
                    } else {
                        wordDiv.classList.add('not-discovered');
                    }

                    wordDiv.innerHTML = `
                        <div class="mini-word-hint">${dica}</div>
                        <div class="mini-word-status">${descoberta ? '‚úì' : ''}</div>
                    `;

                    grid.appendChild(wordDiv);
                }
            });
        }

        function atualizarBotoesBaseadoNoTipo(jogadores) {
            const botaoProntoContainer = document.getElementById('botao-pronto-container');
            const botaoIniciarContainer = document.getElementById('botao-iniciar-container');
            
            const euSouCriador = jogadores.find(j => j.nome === meuNome && j.criador);
            
            if (euSouCriador) {
                // Sou criador: mostrar apenas bot√£o de iniciar partida
                if (botaoProntoContainer) botaoProntoContainer.classList.add('hidden');
                if (botaoIniciarContainer) botaoIniciarContainer.classList.remove('hidden');
                
                // Calcular status dos jogadores (exceto criador)
                const jogadoresNaoCriadores = jogadores.filter(j => !j.criador);
                const jogadoresProntos = jogadoresNaoCriadores.filter(j => j.pronto);
                const todosProntos = jogadoresNaoCriadores.length > 0 && jogadoresProntos.length === jogadoresNaoCriadores.length;
                
                atualizarBotaoIniciarPartida(jogadoresNaoCriadores.length, jogadoresProntos.length, todosProntos);
                
                // Atualizar status da sala
                if (jogadoresNaoCriadores.length === 0) {
                    document.getElementById('status-sala').innerHTML = 
                        `<span class="waiting-status">Aguardando outros jogadores entrarem na sala</span>`;
                } else if (todosProntos) {
                    document.getElementById('status-sala').innerHTML = 
                        `<span class="ready-status">üéâ Todos os ${jogadoresNaoCriadores.length} jogadores est√£o prontos!</span>`;
                } else {
                    document.getElementById('status-sala').innerHTML = 
                        `<span class="waiting-status">‚è≥ ${jogadoresProntos.length}/${jogadoresNaoCriadores.length} jogadores prontos</span>`;
                }
                
            } else {
                // Sou jogador normal: mostrar apenas bot√£o de marcar pronto
                if (botaoIniciarContainer) botaoIniciarContainer.classList.add('hidden');
                if (botaoProntoContainer) botaoProntoContainer.classList.remove('hidden');
                
                // Mostrar status geral
                const jogadoresNaoCriadores = jogadores.filter(j => !j.criador);
                const jogadoresProntos = jogadoresNaoCriadores.filter(j => j.pronto);
                
                if (jogadoresNaoCriadores.length >= 2 && jogadoresProntos.length === jogadoresNaoCriadores.length) {
                    document.getElementById('status-sala').innerHTML = 
                        `<span class="ready-status">üéâ Todos os jogadores est√£o prontos! Aguardando o criador iniciar.</span>`;
                } else {
                    document.getElementById('status-sala').innerHTML = 
                        `<span class="waiting-status">‚è≥ ${jogadoresProntos.length}/${jogadoresNaoCriadores.length} jogadores prontos</span>`;
                }
            }
        }

        // Event listeners para inputs
        document.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const activeElement = document.activeElement;

                if (activeElement.id === 'input-tentativa') {
                    tentarAdivinhar();
                } else if (activeElement.id === 'input-chat') {
                    enviarMensagem();
                }
            }
        });

        // Fun√ß√£o para alterar tema
        function alterarTema(tema) {
            document.body.className = `game-body ${tema}`;
            localStorage.setItem('tema', tema);
            mostrarToast(`Tema alterado para: ${tema.replace('theme-', '').charAt(0).toUpperCase() + tema.replace('theme-', '').slice(1)}`, 'success');
            toggleThemeMenu(); // Fechar menu ap√≥s sele√ß√£o
        }

        // Fun√ß√£o para toggle do menu de temas
        function toggleThemeMenu() {
            const menu = document.getElementById('theme-menu');
            menu.classList.toggle('hidden');
        }

        // Fechar menu de temas ao clicar fora
        document.addEventListener('click', function (e) {
            const themeBtn = document.getElementById('theme-btn');
            const themeMenu = document.getElementById('theme-menu');

            if (!themeBtn.contains(e.target) && !themeMenu.contains(e.target)) {
                themeMenu.classList.add('hidden');
            }
        });

        // Fun√ß√£o para expulsar jogador por nome
        function expulsarJogador(nomeJogador) {
            if (confirm(`Tem certeza que deseja expulsar ${nomeJogador}?`)) {
                socket.emit('expulsar_jogador', {
                    sala: codigoSala,
                    nome: nomeJogador
                });
            }
        }
    </script>
</body>

</html>